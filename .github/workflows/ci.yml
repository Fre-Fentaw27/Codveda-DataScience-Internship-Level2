name: CI - Python Project

on:
  push:
    branches: ["**"] # Run on all branches
  pull_request:
    branches: ["**"] # Check all branches

jobs:
  validate-structure:
    name: 📁 Validate Structure
    runs-on: ubuntu-latest

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: 🔍 Check project structure
        run: |
          echo "Checking project structure..."

          # Check if essential directories exist
          for dir in src data models results notebooks; do
            if [ -d "$dir" ]; then
              echo "✅ Directory exists: $dir"
            else
              echo "⚠️  Directory missing: $dir"
            fi
          done

          # Check if requirements.txt exists
          if [ -f "requirements.txt" ]; then
            echo "✅ requirements.txt exists"
          else
            echo "❌ requirements.txt missing"
            exit 1
          fi

          # Check if main Python files exist
          if [ -d "src" ]; then
            echo "Checking Python files in src..."
            find src -name "*.py" | head -5 | while read file; do
              echo "✅ Python file: $file"
            done
          fi

  code-quality:
    name: 📋 Code Quality
    runs-on: ubuntu-latest
    needs: validate-structure

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: 🐍 Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install flake8

      - name: ✅ Run flake8 (skip missing folders)
        run: |
          for dir in src notebooks tests; do
            if [ -d "$dir" ]; then
              echo "Linting $dir ..."
              # Only check for critical errors that would break code execution
              flake8 "$dir" --select=E9,F63,F7,F82 --show-source --statistics --max-line-length=100
              
              # Show style warnings but don't fail (exit-zero)
              flake8 "$dir" --exit-zero --max-line-length=100 --ignore=E501,W293,E302,F401 --statistics || true
            else
              echo "Directory $dir not found. Skipping..."
            fi
          done

  build:
    name: 🏗️ Build Verification
    runs-on: ubuntu-latest
    needs: [validate-structure, code-quality]

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: 🐍 Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: 📦 Install all dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: ✅ Verify imports work
        run: |
          echo "Testing basic imports..."
          python -c "
          try:
              import pandas as pd
              import numpy as np
              import sklearn
              print('✅ All core imports successful')
          except ImportError as e:
              print(f'❌ Import failed: {e}')
              exit(1)
          "

  test:
    name: 🧪 Run Tests
    runs-on: ubuntu-latest
    needs: build

    steps:
      - name: 📥 Checkout Repository
        uses: actions/checkout@v3
        with:
          lfs: true

      - name: 🐍 Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: 📦 Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: ✅ Run tests
        run: |
          # Run tests if tests directory exists
          if [ -d "tests" ]; then
            python -m pytest tests/ -v --tb=short
          else
            echo "No tests directory found. Skipping tests."
          fi

  success-notification:
    name: ✅ Success Notification
    runs-on: ubuntu-latest
    needs: [build, test]
    if: success()

    steps:
      - name: 📨 Notify success
        run: |
          echo "🎉 All CI checks passed successfully!"
          echo "Project is ready for deployment."

  failure-notification:
    name: ❌ Failure Notification
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: 📨 Notify failure
        run: |
          echo "❌ CI pipeline failed. Please check the logs for details."
          exit 1
