name: CI - Data Science Project

on:
  push:
    branches: ["**"] # Run on all branches
  pull_request:
    branches: ["**"] # Check all branches

jobs:
  code-quality:
    name: ğŸ“‹ Code Quality
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install black flake8

      - name: ğŸ¨ Check code formatting with Black
        run: |
          # Check Python files in src directory
          if [ -d "src" ]; then
            python -m black --check src/ --line-length 100
          else
            echo "No src directory found. Skipping Black check."
          fi

      - name: ğŸ” Lint with flake8
        run: |
          # Lint Python files in src directory
          if [ -d "src" ]; then
            python -m flake8 src/ --max-line-length=100 --ignore=E203,W503 --count --statistics
          else
            echo "No src directory found. Skipping flake8."
          fi

  test:
    name: ğŸ§ª Run Tests
    runs-on: ubuntu-latest
    needs: code-quality

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi
          pip install pytest

      - name: âœ… Run tests
        run: |
          # Run tests if tests directory exists
          if [ -d "tests" ]; then
            python -m pytest tests/ -v
          else
            echo "No tests directory found. Skipping tests."
          fi

  validate-structure:
    name: ğŸ“ Validate Structure
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ” Check project structure
        run: |
          echo "Checking project structure..."

          # Check if essential directories exist
          for dir in src data models results; do
            if [ -d "$dir" ]; then
              echo "âœ… Directory exists: $dir"
            else
              echo "âš ï¸  Directory missing: $dir"
            fi
          done

          # Check if requirements.txt exists
          if [ -f "requirements.txt" ]; then
            echo "âœ… requirements.txt exists"
          else
            echo "âŒ requirements.txt missing"
            exit 1
          fi

          # Check if main Python files exist
          if [ -d "src" ]; then
            echo "Checking Python files in src..."
            find src -name "*.py" | head -5 | while read file; do
              echo "âœ… Python file: $file"
            done
          fi

  build:
    name: ğŸ—ï¸ Build Verification
    runs-on: ubuntu-latest
    needs: [code-quality, test, validate-structure]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ Set up Python 3.9
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: ğŸ“¦ Install all dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: âœ… Verify imports work
        run: |
          echo "Testing basic imports..."
          python -c "
          try:
              import pandas as pd
              import numpy as np
              import sklearn
              print('âœ… All core imports successful')
          except ImportError as e:
              print(f'âŒ Import failed: {e}')
              exit(1)
          "

  success-notification:
    name: âœ… Success Notification
    runs-on: ubuntu-latest
    needs: build
    if: success()

    steps:
      - name: ğŸ“¨ Notify success
        run: |
          echo "ğŸ‰ All CI checks passed successfully!"
          echo "Project is ready for deployment."

  failure-notification:
    name: âŒ Failure Notification
    runs-on: ubuntu-latest
    if: failure()

    steps:
      - name: ğŸ“¨ Notify failure
        run: |
          echo "âŒ CI pipeline failed. Please check the logs for details."
          exit 1
